schema: '2.0'
stages:
  preprocess_wellcome_science:
    cmd: grants_tagger preprocess wellcome-science data/raw/science_tags_full_version.xlsx
      data/processed/science_grants_tagged_title_synopsis.jsonl models/label_binarizer.pkl
    deps:
    - path: data/raw/science_tags_full_version.xlsx
      md5: 74da2bf7a507e52b8b677ddce19156a9
      size: 2638299
    - path: grants_tagger/preprocess_wellcome.py
      md5: 738ccb78c7ee261c7e934cd4196e9b46
      size: 6654
    params:
      params.yaml:
        preprocess_wellcome_science.meta_cols: Grant_ID,Title
        preprocess_wellcome_science.text_cols: Title,Synopsis
    outs:
    - path: data/processed/science_grants_tagged_title_synopsis.jsonl
      md5: 2fb37d57daeece50a0190e16e229647a
      size: 2809039
    - path: models/label_binarizer.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
  train:
    cmd: grants_tagger train data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer.pkl models/tfidf-svm-2020.05.2.pkl --approach tfidf-svm
    deps:
    - path: data/processed/science_grants_tagged_title_synopsis.jsonl
      md5: 2fb37d57daeece50a0190e16e229647a
      size: 2809039
    - path: grants_tagger/train.py
      md5: 162e8650a0a7e970420f48eb5c253f82
      size: 3970
    params:
      params.yaml:
        train.class_weight: balanced
        train.min_df: 5
        train.ngram_range:
        - 1
        - 2
    outs:
    - path: models/label_binarizer.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/tfidf-svm-2020.05.2.pkl
      md5: eceaf3846999e47380ca670c096b810a
      size: 17768856
  train_tfidf_svm:
    cmd: grants_tagger train data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer.pkl models/tfidf-svm.pkl --approach tfidf-svm --train-info
      results/tfidf_svm_train_info.json
    deps:
    - path: data/processed/science_grants_tagged_title_synopsis.jsonl
      md5: 2fb37d57daeece50a0190e16e229647a
      size: 2809039
    - path: grants_tagger/train.py
      md5: 7ad0632959accc481d8d5300f3c9fd84
      size: 5996
    params:
      params.yaml:
        train.tfidf-svm.svm__estimator.class_weight: balanced
        train.tfidf-svm.tfidf.min_df: 5
        train.tfidf-svm.tfidf.ngram_range:
        - 1
        - 2
    outs:
    - path: models/tfidf-svm.pkl
      md5: 38f35b3381d116adad18dc5e2a7dab03
      size: 17768857
    - path: results/tfidf_svm_train_info.json
      md5: 6f98a7bec4325ece260581465a1d9847
      size: 62
  evaluate:
    cmd: grants_tagger evaluate model tfidf-svm models/tfidf-svm-2020.05.2.pkl data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer.pkl
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: cd583e8d10e0c889647834cab217ce2f
      size: 1872
    - path: models/label_binarizer.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/tfidf-svm-2020.05.2.pkl
      md5: f24b224be6a867f96400b3df2ad26ac9
      size: 17768856
    outs:
    - path: results.json
      md5: 1d0d4fb63ae1d1b911373cc558147737
      size: 89
  evaluate_tfidf_svm:
    cmd: grants_tagger evaluate model tfidf-svm models/tfidf-svm.pkl data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer.pkl --results-path results/tfidf_svm.json
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: d184ff6cda5a492977586d85d9b19328
      size: 5774
    - path: models/label_binarizer.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/tfidf-svm.pkl
      md5: 38f35b3381d116adad18dc5e2a7dab03
      size: 17768857
    outs:
    - path: results/tfidf_svm.json
      md5: b2f118de649f2da71cb40b5f8694fcf1
      size: 120
  train_scibert:
    cmd: grants_tagger train data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer.pkl models/scibert --approach scibert --train-info results/scibert_train_info.json
    deps:
    - path: data/processed/science_grants_tagged_title_synopsis.jsonl
      md5: 2fb37d57daeece50a0190e16e229647a
      size: 2809039
    - path: grants_tagger/train.py
      md5: 7ad0632959accc481d8d5300f3c9fd84
      size: 5996
    params:
      params.yaml:
        train.scibert.epochs: 10
        train.scibert.learning_rate: 2e-05
        train.scibert.validation_split: 0.1
    outs:
    - path: models/scibert
      md5: 5cf7e7f8e11a1e00d1c214d637618b85.dir
      size: 440020006
      nfiles: 2
  evaluate_scibert:
    cmd: grants_tagger evaluate model scibert models/scibert data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer.pkl --results-path results/scibert.json
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: d184ff6cda5a492977586d85d9b19328
      size: 5774
    - path: models/label_binarizer.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/scibert
      md5: 5cf7e7f8e11a1e00d1c214d637618b85.dir
      size: 440020006
      nfiles: 2
    outs:
    - path: results/scibert.json
      md5: 936e3229c02ea1a562eeb90298d1ecca
      size: 120
  preprocess_bioasq_mesh:
    cmd: grants_tagger preprocess bioasq-mesh data/raw/allMeSH_2021.json data/processed/train_mesh2021.jsonl
      models/xlinear/label_binarizer.pkl --test-split 0.01 --test-output-path data/processed/test_mesh2021.jsonl
      --mesh-tags-path data/processed/descriptors_to_use.csv
    deps:
    - path: data/raw/allMeSH_2021.json
      md5: e827a6b8062d1312664dcf075c12d89f
      size: 27547042745
    - path: grants_tagger/preprocess_mesh.py
      md5: 4a6539c093e465852206e4455e67cda3
      size: 5675
    outs:
    - path: data/processed/test_mesh2021.jsonl
      md5: 115bd2bd5160abcd694e8db2e3c58a37
      size: 256267517
    - path: data/processed/train_mesh2021.jsonl
      md5: 406d3a55e34626957d0cb78ac290ca42
      size: 25370915640
    - path: models/xlinear/label_binarizer.pkl
      md5: e724374be69ab326b744992e83f4101a
      size: 622342
  evaluate_science_ensemble:
    cmd: grants_tagger evaluate model science-ensemble models/tfidf-svm.pkl,models/scibert
      data/processed/science_grants_tagged_title_synopsis.jsonl models/label_binarizer.pkl
      --results-path results/science_ensemble.json
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: d184ff6cda5a492977586d85d9b19328
      size: 5774
    - path: models/label_binarizer.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/scibert
      md5: 5cf7e7f8e11a1e00d1c214d637618b85.dir
      size: 440020006
      nfiles: 2
    - path: models/tfidf-svm.pkl
      md5: 38f35b3381d116adad18dc5e2a7dab03
      size: 17768857
    outs:
    - path: results/science_ensemble.json
      md5: a9fb045af166aa9901e7cd89678fed25
      size: 120
  train_mesh_cnn:
    cmd: grants_tagger train data/processed/disease_mesh.jsonl models/disease_mesh_label_binarizer-2021.06.0.pkl
      models/disease_mesh_cnn-2021.06.0 --approach mesh-cnn --sparse-labels
    deps:
    - path: data/processed/disease_mesh.jsonl
      md5: f4463f861869e7516caef78ff75600ac
      size: 12179582610
    - path: grants_tagger/models.py
      md5: 234124a679b6f761241c4ff7ba7b2fd7
      size: 25324
    - path: grants_tagger/train.py
      md5: 78683e5785fe5f403b4d1f58211b5dc8
      size: 3971
    params:
      params.yaml:
        train.mesh-cnn.cnn.attention: true
        train.mesh-cnn.cnn.batch_size: 256
        train.mesh-cnn.cnn.dense_size: 10000
        train.mesh-cnn.cnn.dropout: 0.1
        train.mesh-cnn.cnn.hidden_size: 400
        train.mesh-cnn.cnn.l2: 7e-07
        train.mesh-cnn.cnn.learning_rate: 0.0001
        train.mesh-cnn.cnn.learning_rate_decay: 0.8
        train.mesh-cnn.cnn.multilabel: true
        train.mesh-cnn.cnn.nb_epochs: 10
        train.mesh-cnn.vec.sequence_length: 400
        train.mesh-cnn.vec.tokenizer_library: transformers
        train.mesh-cnn.vec.vocab_size: 30000
    outs:
    - path: models/disease_mesh_cnn-2021.06.0
      md5: 08ec776180c1d45ff0f35024833f843d.dir
      size: 808278043
      nfiles: 5
    - path: models/disease_mesh_label_binarizer-2021.06.0.pkl
      md5: 85be50a39457aa83f1dd4fbb2b1f26b6
      size: 147371
  filter_mesh_tags:
    cmd: python grants_tagger/filter_mesh_tags.py data/raw/desc2021.xml data/processed/mesh_disease_tags.csv
    deps:
    - path: data/raw/desc2021.xml
      md5: 8663a7dd8e1895dd22525d42b80cd2df
      size: 300410104
    outs:
    - path: data/processed/mesh_disease_tags.csv
      md5: 4311b12fb4f381ffab1d76f55069683d
      size: 260080
  train_mesh_xlinear:
    cmd: grants_tagger train data/processed/train_mesh2021.jsonl models/xlinear/label_binarizer.pkl
      models/xlinear/model-2022.12.0 --approach mesh-xlinear --sparse-labels --train-info
      results/mesh_xlinear_train_info.json --slim
    deps:
    - path: data/processed/train_mesh2021.jsonl
      md5: 406d3a55e34626957d0cb78ac290ca42
      size: 25370915640
    - path: grants_tagger/slim/mesh_xlinear.py
      md5: 56a24b32c2a49032be5009ffab01f3f7
      size: 5735
    - path: grants_tagger/train.py
      md5: c94acba1bef2ecf4a904975070bd5ae0
      size: 5702
    params:
      params.yaml:
        train.mesh-xlinear.config: configs/mesh/2022.9.0.ini
    outs:
    - path: models/xlinear/model-2022.12.0
      md5: 40b03c66a9c8c263249b91ec1c484e16.dir
      size: 3715243412
      nfiles: 34
  evaluate_mesh_xlinear_on_grants:
    cmd: grants_tagger evaluate grants mesh-xlinear models/xlinear/model-2022.9.0
      data/raw/disease_tags_validation_grants.xlsx models/xlinear/label_binarizer-2022.9.0.pkl
      --results-path results/mesh_xlinear_on_grants.json --mesh-tags-path data/processed/mesh_disease_tags.csv
    deps:
    - path: data/processed/mesh_disease_tags.csv
      md5: 4311b12fb4f381ffab1d76f55069683d
      size: 260080
    - path: data/raw/disease_tags_validation_grants.xlsx
      md5: 71554cf90758773fb996351000384d4f
      size: 615751
    - path: grants_tagger/evaluate_mesh_on_grants.py
      md5: f19ad62ab308aa3534d7eb7718b8b701
      size: 4218
    - path: models/xlinear/label_binarizer-2022.9.0.pkl
      md5: fd76765990862184bef555e9b008dc90
      size: 622958
    - path: models/xlinear/model-2022.9.0
      md5: 5171e58ce5db427d5d198d134757b551.dir
      size: 3714100920
      nfiles: 34
    outs:
    - path: results/mesh_xlinear_on_grants.json
      md5: 7b4296cb3fd3bb73e88033054ac44128
      size: 26
  evaluate_mesh_xlinear:
    cmd: grants_tagger evaluate model mesh-xlinear models/xlinear/model-2022.9.0 data/processed/test_mesh2021.jsonl
      models/xlinear/label_binarizer-2022.9.0.pkl --results-path results/mesh_xlinear.json
      --full-report-path results/mesh_xlinear_full_report.json --no-split-data
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: d184ff6cda5a492977586d85d9b19328
      size: 5774
    - path: models/xlinear/label_binarizer-2022.9.0.pkl
      md5: fd76765990862184bef555e9b008dc90
      size: 622958
    - path: models/xlinear/model-2022.9.0
      md5: 5171e58ce5db427d5d198d134757b551.dir
      size: 3714100920
      nfiles: 34
    outs:
    - path: results/mesh_xlinear.json
      md5: 2b10d4aa18e14776d1d1008a88e36bf7
      size: 120
  generate_validation_data_xlinear:
    cmd: python scripts/generate_validation_data_xlinear.py
    deps:
    - path: data/interim/mesh_pipeline_result.csv
      md5: 10639bbe244b986919efc8f7866b98b4
      size: 138862818
    - path: data/raw/grants.csv
      md5: 9732c21dd1954cce8baaf3746f301ead
      size: 152523849
    - path: scripts/generate_validation_data_xlinear.py
      md5: e3eb14350c3ea5f7692cce5a48fed5fe
      size: 2734
    outs:
    - path: data/processed/merged_mesh_predictions_mesh_xlinear_for_validation.xlsx
      md5: f174b02bf804885f769816cc27540b89
      size: 40795153
  get_grants:
    cmd: python scripts/get_grants.py
    deps:
    - path: scripts/get_grants.py
      md5: 50c0cf255eb0252fd4f3412920430d19
      size: 1010
    outs:
    - path: data/raw/grants.csv
      md5: 9732c21dd1954cce8baaf3746f301ead
      size: 152523849
  preprocess_bioasq_mesh_toy:
    cmd: grants_tagger preprocess bioasq-mesh data/raw/allMeSH_2021.json data/processed/train_mesh2021_toy.jsonl
      models/xlinear-toy/label_binarizer_toy.pkl --test-split 0.01 --test-output-path
      data/processed/test_mesh2021_toy.jsonl --n-max 1000
    deps:
    - path: data/processed/wt_tags_used.csv
      md5: a2b7c13fc9d40732e1777b4e6e7a6454
      size: 638161
    - path: data/raw/allMeSH_2021.json
      md5: e827a6b8062d1312664dcf075c12d89f
      size: 27547042745
    - path: grants_tagger/preprocess_mesh.py
      md5: 4a6539c093e465852206e4455e67cda3
      size: 5675
    outs:
    - path: data/processed/test_mesh2021_toy.jsonl
      md5: 4854f52928e0f018e9c062ccf7479d75
      size: 17777
    - path: data/processed/train_mesh2021_toy.jsonl
      md5: 76794bc0196dc76873a7b201c3ded238
      size: 1926754
    - path: models/xlinear-toy/label_binarizer_toy.pkl
      md5: 283840651200a26d659e579dc289d608
      size: 66407
  preprocess_bioasq_mesh_wt_only:
    cmd: grants_tagger preprocess bioasq-mesh data/raw/allMeSH_2021.json data/processed/train_mesh2021_wt.jsonl
      models/xlinear-wt/label_binarizer_wt.pkl --test-split 0.01 --test-output-path
      data/processed/test_mesh2021_wt.jsonl --mesh-tags-path data/processed/wt_tags_used.csv
    deps:
    - path: data/processed/wt_tags_used.csv
      md5: a2b7c13fc9d40732e1777b4e6e7a6454
      size: 638161
    - path: data/raw/allMeSH_2021.json
      md5: e827a6b8062d1312664dcf075c12d89f
      size: 27547042745
    - path: grants_tagger/preprocess_mesh.py
      md5: 4a6539c093e465852206e4455e67cda3
      size: 5675
    outs:
    - path: data/processed/test_mesh2021_wt.jsonl
      md5: 57a645119f4b794f5fe2796839945a13
      size: 255911103
    - path: data/processed/train_mesh2021_wt.jsonl
      md5: 52b0358e553f4b373f06c5f1c13672f8
      size: 25357487172
    - path: models/xlinear-wt/label_binarizer_wt.pkl
      md5: 75224e7ef280c0c0437e0001b5a5ef77
      size: 541138
  create_inclusion_list:
    cmd: python grants_tagger/create_inclusion_list.py data/raw/desc2021.xml data/processed/descriptors_not_to_use_manual.csv
      data/processed/descriptors_to_use.csv
    deps:
    - path: data/raw/desc2021.xml
      md5: 8663a7dd8e1895dd22525d42b80cd2df
      size: 300410104
    outs:
    - path: data/processed/descriptors_to_use.csv
      md5: 30442dde9553e8a29042532f99e43558
      size: 746237
  train_mesh_xlinear_toy:
    cmd: grants_tagger train data/processed/train_mesh2021_toy.jsonl models/xlinear-toy/label_binarizer_toy.pkl
      models/xlinear-toy/model-2022.12.0 --approach mesh-xlinear --sparse-labels --train-info
      results/mesh_xlinear_train_info_toy.json --slim
    deps:
    - path: data/processed/train_mesh2021_toy.jsonl
      md5: 76794bc0196dc76873a7b201c3ded238
      size: 1926754
    - path: grants_tagger/slim/mesh_xlinear.py
      md5: 56a24b32c2a49032be5009ffab01f3f7
      size: 5735
    - path: grants_tagger/train.py
      md5: c94acba1bef2ecf4a904975070bd5ae0
      size: 5702
    params:
      params.yaml:
        train.mesh-xlinear.config: configs/mesh/2022.9.0.ini
    outs:
    - path: models/xlinear-toy/model-2022.12.0
      md5: 4d7fd8a2710ae19eedf1f49b890a7cf6.dir
      size: 2645125
      nfiles: 25
  train_mesh_xlinear_wt_only:
    cmd: grants_tagger train data/processed/train_mesh2021_wt.jsonl models/xlinear-wt/label_binarizer_toy.pkl
      models/xlinear-wt/model-2022.12.0 --approach mesh-xlinear --sparse-labels --train-info
      results/mesh_xlinear_train_info_wt.json --slim
    deps:
    - path: data/processed/train_mesh2021_wt.jsonl
      md5: 52b0358e553f4b373f06c5f1c13672f8
      size: 25357487172
    - path: grants_tagger/slim/mesh_xlinear.py
      md5: 56a24b32c2a49032be5009ffab01f3f7
      size: 5735
    - path: grants_tagger/train.py
      md5: c94acba1bef2ecf4a904975070bd5ae0
      size: 5702
    params:
      params.yaml:
        train.mesh-xlinear.config: configs/mesh/2022.9.0.ini
    outs:
    - path: models/xlinear-wt/model-2022.12.0
      md5: 3d71697eec4ec4e222c8c133927c7c55.dir
      size: 3470257704
      nfiles: 31
  evaluate_mesh_xlinear_wt_only:
    cmd: grants_tagger evaluate model mesh-xlinear models/xlinear-wt/model-2022.9.0
      data/processed/test_mesh2021_wt.jsonl models/xlinear-wt/label_binarizer_wt.pkl
      --results-path results/mesh_xlinear_wt_only.json --full-report-path results/mesh_xlinear_full_report_wt_only.json
      --no-split-data
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: d184ff6cda5a492977586d85d9b19328
      size: 5774
    - path: models/xlinear-wt/label_binarizer_wt.pkl
      md5: 75224e7ef280c0c0437e0001b5a5ef77
      size: 541138
    - path: models/xlinear-wt/model-2022.9.0
      md5: 4606dbbd09edb34aacaf565b1f552b3f.dir
      size: 3470257704
      nfiles: 31
    outs:
    - path: results/mesh_xlinear_wt_only.json
      md5: cef90bdba2ef2cf30ea69714f51ed1f0
      size: 120
